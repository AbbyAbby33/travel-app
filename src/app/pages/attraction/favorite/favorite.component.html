<h2 class="page-title">æˆ‘çš„æœ€æ„›</h2>

<p class="result-count">å…± {{ favorites.length }} å€‹æ”¶è—æ™¯é»</p>

<!-- æˆ‘çš„æœ€æ„›æ“ä½œ -->
@if (displayedFavorites.length > 0) {
<div class="batch-actions">
  <div class="batch-left">
    <label class="checkbox-label">
      <input type="checkbox" [checked]="isAllSelected()" (change)="toggleSelectAll()">
      <span> å…¨é¸</span>
    </label>
    @if (selectedFavorites.size > 0) {
    <span class="selected-count">
      å·²é¸ {{ selectedFavorites.size }} é …
    </span>
    }
  </div>

  <button class="btn" [disabled]="selectedFavorites.size === 0" (click)="removeSelectedFromFavorites()">
    ç§»é™¤æˆ‘çš„æœ€æ„›
  </button>
</div>
}

<div class="favorite-list">
  @for (favorite of displayedFavorites; track favorite.id) {
  <!-- æˆ‘çš„æœ€æ„›åˆ—è¡¨ -->
  <div class="favorite-card" [class.editing]="isEditing(favorite.id)">

    <!-- åœ–ç‰‡ -->
    @if(favorite.images && favorite.images.length > 0) {
    <div class="card-image">
      <img [src]="favorite.images[0].src" [alt]="favorite.name">
    </div>
    }

    <!-- å…§å®¹ -->
    @if (!isEditing(favorite.id)){
    <!-- é¡¯ç¤ºæ¨¡å¼ -->
    <div class="card-view card-content">
      <div class="favorite-operate">
        <div class="card-checkbox">
          <input type="checkbox" [checked]="isSelected(favorite.id)" (change)="toggleSelection(favorite.id)">
        </div>
      </div>
      
      <h3 class="card-title">{{ favorite.name }}</h3>

      <p class="card-description">
        {{ favorite.introduction | slice:0:100 }}{{ favorite.introduction!.length > 100 ? '...' : '' }}
      </p>

      <div class="card-info">
        <div class="info-item">
          <span class="info-icon">ğŸ“</span>
          <span class="info-text">{{ favorite.address }}</span>
        </div>

        <div class="info-item">
          <span class="info-icon">ğŸ“</span>
          <span class="info-text">{{ favorite.tel }}</span>
        </div>
      </div>

      <div class="card-actions">
        <button class="btn btn-edit" (click)="startEdit(favorite)">
          ç·¨è¼¯
        </button>
        <button class="btn btn-remove" (click)="removeFromFavorites(favorite.id)">
          ç§»é™¤
        </button>
      </div>
    </div>
    }

    <!-- ç·¨è¼¯æ¨¡å¼ -->
    @if (isEditing(favorite.id)) {
    <div class="card-edit card-content">
      <form [formGroup]="editForm" (ngSubmit)="saveEdit(favorite)">
        <div class="edit-header">
          <h3>ç·¨è¼¯æ™¯é»è³‡è¨Š</h3>
        </div>

        <div class="form-group">
          <label for="name" class="form-label">
            æ™¯é»åç¨± <span class="required">*</span>
          </label>
          <input type="text" id="name" class="form-control" formControlName="name" placeholder="è«‹è¼¸å…¥æ™¯é»åç¨±">
          @if (formControls['name'].invalid && formControls['name'].touched) {
          <div class="error-message">
            @if (formControls['name'].errors?.['required']) {
            <span>
              æ™¯é»åç¨±ç‚ºå¿…å¡«æ¬„ä½
            </span>
            }
            @if (formControls['name'].errors?.['minlength']) {
            <span>
              æ™¯é»åç¨±è‡³å°‘éœ€è¦2å€‹å­—å…ƒ
            </span>
            }
          </div>
          }
        </div>

        <div class="form-group">
          <label for="address" class="form-label">åœ°å€</label>
          <input type="text" id="address" class="form-control" formControlName="address" placeholder="è«‹è¼¸å…¥åœ°å€">
        </div>

        <div class="form-group">
          <label for="tel" class="form-label">é›»è©±</label>
          <input type="text" id="tel" class="form-control" formControlName="tel" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼">
          @if (formControls['tel'].invalid && formControls['tel'].touched) {
          <div class="error-message">
            @if (formControls['tel'].errors?.['containsChinese']) {
            <span>
              é›»è©±è™Ÿç¢¼ä¸å¯åŒ…å«ä¸­æ–‡å­—å…ƒ
            </span>
            }
          </div>
          }
        </div>

        <div class="form-group">
          <label for="introduction" class="form-label">æ™¯é»ä»‹ç´¹</label>
          <textarea id="introduction" class="form-control" formControlName="introduction" rows="4"
            placeholder="è«‹è¼¸å…¥æ™¯é»ä»‹ç´¹"></textarea>
        </div>

        <div class="card-actions">
          <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
            å–æ¶ˆ
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="editForm.invalid">
            å„²å­˜
          </button>
        </div>
      </form>
    </div>
    }

  </div>
  } @empty {
  <!-- ç„¡è³‡æ–™ -->
  <div class="no-data">
    <p>ç›®å‰æ²’æœ‰æ”¶è—çš„æ™¯é»</p>
  </div>
  }
</div>

<!-- åˆ†é  -->
@if (displayedFavorites.length > 0) {
<div class="pagination">
  <button class="page-btn" [disabled]="currentPage === 1" (click)="previousPage()">
    ä¸Šä¸€é 
  </button>

  <!-- ä¸­é–“é ç¢¼ -->
  <div class="page-numbers">
    @if (currentPage > 3) {
    <button class="page-number" (click)="goToPage(1)">
      1
    </button>
    }

    @if( currentPage > 3) {
    <span class="page-ellipsis">...</span>
    }

    @for (page of getPageRange(); track $index) {
    <button class="page-number" [class.active]="page === currentPage" (click)="goToPage(page)">
      {{ page }}
    </button>
    }

    @if (currentPage < totalPages - 2) { <span class="page-ellipsis">...</span>
      }

      @if (currentPage < totalPages - 2) { <button class="page-number" (click)="goToPage(totalPages)">
        {{ totalPages }}
        </button>
        }

  </div>

  <button class="page-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
    ä¸‹ä¸€é 
  </button>
</div>
}
